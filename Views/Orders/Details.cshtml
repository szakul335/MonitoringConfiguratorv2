@using Microsoft.AspNetCore.Identity
@model MonitoringConfigurator.Models.Order
@{
    ViewData["Title"] = $"Zamówienie #{Model.Id}";

    // Sprawdzamy uprawnienia
    bool isStaff = User.IsInRole("Admin") || User.IsInRole("Operator");

    // Pobieramy dane przekazane z kontrolera (jeśli istnieją)
    var owner = ViewBag.OwnerUser as IdentityUser;
    var claims = ViewBag.OwnerClaims as Dictionary<string, string>;

    // Funkcja pomocnicza do bezpiecznego pobierania wartości z claims
    string GetClaim(string key) => (claims != null && claims.ContainsKey(key)) ? claims[key] : "-";
}

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white">Zamówienie #@Model.Id</h2>
        <a asp-action="Index" class="btn btn-outline-secondary">Powrót do listy</a>
    </div>

    @* --- SEKCJA DANYCH KLIENTA (WIDOCZNA TYLKO DLA ADMINA/OPERATORA) --- *@
    @if (isStaff && owner != null)
    {
        <div class="card bg-dark border-info mb-4">
            <div class="card-header border-info text-info fw-bold">
                <i class="bi bi-person-lines-fill me-2"></i> Dane zamawiającego
            </div>
            <div class="card-body text-white">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6 class="text-muted text-uppercase small">Dane kontaktowe</h6>
                        <ul class="list-unstyled">
                            <li class="mb-1"><strong>Imię i nazwisko:</strong> @GetClaim("profile:fullName")</li>
                            <li class="mb-1"><strong>Firma:</strong> @GetClaim("profile:company")</li>
                            <li class="mb-1"><strong>Email:</strong> <a href="mailto:@owner.Email" class="text-info text-decoration-none">@owner.Email</a></li>
                            <li class="mb-1"><strong>Telefon:</strong> @(owner.PhoneNumber ?? "-")</li>
                        </ul>
                    </div>
                    <div class="col-md-6 mb-3">
                        @* Pusta przestrzeń dla wyrównania (opcjonalnie) lub po prostu brak nagłówka *@
                        <div style="height: 1.4em;"></div>
                        <ul class="list-unstyled">
                          
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }
    @* ------------------------------------------------------------------- *@

    <div class="card bg-dark border-secondary">
        <div class="card-header border-secondary">
            <div class="d-flex justify-content-between text-white">
                <span>Data: <strong>@Model.OrderDate.ToLocalTime().ToString("g")</strong></span>
                <span>Status: <span class="badge bg-success">Przyjęte</span></span>
            </div>
        </div>
        <div class="card-body p-0">
            <table class="table table-dark table-striped mb-0">
                <thead>
                    <tr>
                        <th class="ps-4">Produkt</th>
                        <th class="text-center">Ilość</th>
                        <th class="text-end">Cena jedn.</th>
                        <th class="text-end pe-4">Wartość</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Items)
                    {
                        <tr>
                            <td class="ps-4">
                                <div>@item.Product.Name</div>
                                <small class="text-muted">@item.Product.Brand @item.Product.Model</small>
                            </td>
                            <td class="text-center">@item.Quantity</td>
                            <td class="text-end">@item.UnitPrice.ToString("N2") zł</td>
                            <td class="text-end pe-4">@((item.UnitPrice * item.Quantity).ToString("N2")) zł</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="fs-5">
                        <td colspan="3" class="text-end fw-bold pt-3">Suma:</td>
                        <td class="text-end fw-bold text-danger pe-4 pt-3">@Model.TotalAmount.ToString("N2") zł</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>