@model MonitoringConfigurator.Models.Contact
@{
    ViewData["Title"] = "Szczegóły zgłoszenia";
    // Łączymy wątek główny i odpowiedzi w jedną listę i sortujemy
    var allMessages = new List<MonitoringConfigurator.Models.Contact> { Model };
    if (Model.Replies != null)
    {
        allMessages.AddRange(Model.Replies);
    }
    allMessages = allMessages.OrderBy(m => m.CreatedAt).ToList();
}

<div class="container py-4">
    <a asp-action="Support" class="btn btn-outline-secondary mb-3">&larr; Powrót do listy zgłoszeń</a>

    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
            <span>Temat: <strong>@Model.Subject</strong></span>
            @switch (Model.Status)
            {
                case MonitoringConfigurator.Models.ContactStatus.Closed:
                    <span class="badge bg-secondary">ZAMKNIĘTE</span>
                    break;
                case MonitoringConfigurator.Models.ContactStatus.Replied:
                    <span class="badge bg-success text-dark">NOWA ODPOWIEDŹ</span>
                    break;
                default:
                    <span class="badge bg-primary">OTWARTE</span>
                    break;
            }
        </div>

        <div class="card-body bg-light" style="max-height: 600px; overflow-y: auto;">
            @foreach (var msg in allMessages)
            {
                // Jeśli UserId wiadomości == ID właściciela wątku -> to Klient
                bool isMe = (msg.UserId == Model.UserId);

                <div class="d-flex mb-3 @(isMe ? "justify-content-end" : "justify-content-start")">
                    <div class="card shadow-sm @(isMe ? "border-primary" : "border-secondary")" style="max-width: 80%;">
                        <div class="card-header p-2 small @(isMe ? "bg-primary text-white" : "bg-secondary text-white")">
                            <strong>@(isMe ? "Ty" : "Wsparcie")</strong> &bull; @msg.CreatedAt.ToLocalTime().ToString("dd.MM HH:mm")
                        </div>
                        <div class="card-body p-3">
                            <p class="mb-0" style="white-space: pre-wrap;">@msg.Message</p>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (Model.Status != MonitoringConfigurator.Models.ContactStatus.Closed)
        {
            <div class="card-footer bg-white">
                <form asp-action="ReplyToTicket" method="post">
                    <input type="hidden" name="parentId" value="@Model.Id" />
                    <div class="input-group">
                        <textarea name="message" class="form-control" rows="2" placeholder="Napisz odpowiedź..." required></textarea>
                        <button class="btn btn-primary" type="submit">Wyślij</button>
                    </div>
                </form>
            </div>
        }
        else
        {
            <div class="card-footer text-muted text-center bg-light">
                Ten wątek został zamknięty. Jeśli masz nowy problem, utwórz nowe zgłoszenie.
            </div>
        }
    </div>
</div>