@model MonitoringConfigurator.Models.ConfiguratorInputModel
@using MonitoringConfigurator.Models
@{
    ViewData["Title"] = "Konfigurator CCTV Pro";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-white">Zaawansowany Konfigurator</h1>
        <p class="text-muted lead">Zaprojektuj system: wypełnij formularz LUB narysuj to na planie.</p>
    </div>

    <form asp-action="Calculate" method="post" id="mainForm">
        @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })
        <input type="hidden" asp-for="CustomCableMeters" id="hiddenCableMeters" />

        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active px-4 px-md-5 fw-bold" id="pills-form-tab" data-bs-toggle="pill" data-bs-target="#pills-form" type="button" role="tab">1. Parametry</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link px-4 px-md-5 fw-bold" id="pills-visual-tab" data-bs-toggle="pill" data-bs-target="#pills-visual" type="button" role="tab">2. Mapa / Rzut</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">

            <div class="tab-pane fade show active" id="pills-form" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card card-dark h-100 shadow-sm border-secondary">
                            <div class="card-header bg-transparent border-secondary py-3">
                                <h5 class="mb-0 text-white"><i class="bi bi-geo-alt-fill text-danger me-2"></i> 1. Obiekt</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="Building" class="form-label text-muted small fw-bold">TYP BUDYNKU</label>
                                    <select asp-for="Building" class="form-select form-select-dark" asp-items="Html.GetEnumSelectList<BuildingType>()"></select>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="AreaM2" class="form-label text-muted small fw-bold">POWIERZCHNIA (m²)</label>
                                    <input asp-for="AreaM2" class="form-control form-control-dark" type="number" />
                                </div>
                                <div class="mb-3">
                                    <label asp-for="InstallType" class="form-label text-muted small fw-bold">MONTAŻ KABLI</label>
                                    <select asp-for="InstallType" class="form-select form-select-dark" asp-items="Html.GetEnumSelectList<InstallationType>()"></select>
                                </div>
                                <div class="form-check form-switch mt-4">
                                    <input asp-for="NeedAssembly" class="form-check-input" type="checkbox">
                                    <label class="form-check-label text-white fw-bold" asp-for="NeedAssembly">Wyceń usługę montażu</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card card-dark h-100 shadow-sm border-secondary">
                            <div class="card-header bg-transparent border-secondary py-3">
                                <h5 class="mb-0 text-white"><i class="bi bi-camera-reels text-danger me-2"></i> 2. Kamery</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="Tech" class="form-label text-muted small fw-bold text-uppercase">Technologia</label>
                                    <select asp-for="Tech" class="form-select form-select-dark" asp-items="Html.GetEnumSelectList<CameraTechnology>()"></select>
                                </div>

                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label asp-for="OutdoorCamCount" class="form-label text-white small">Zewn. (szt)</label>
                                        <input asp-for="OutdoorCamCount" id="OutdoorCamCount" class="form-control form-control-dark text-center" type="number" min="0" />
                                    </div>
                                    <div class="col-6">
                                        <label asp-for="IndoorCamCount" class="form-label text-white small">Wewn. (szt)</label>
                                        <input asp-for="IndoorCamCount" id="IndoorCamCount" class="form-control form-control-dark text-center" type="number" min="0" />
                                    </div>
                                    <div class="col-12"><small class="text-muted fst-italic">* Wpisz ilość ręcznie lub dodaj na mapie</small></div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="ResolutionMp" class="form-label text-muted small fw-bold">JAKOŚĆ (MPIX)</label>
                                    <select asp-for="ResolutionMp" class="form-select form-select-dark">
                                        <option value="2">2 Mpix (Full HD)</option>
                                        <option value="4">4 Mpix (2K)</option>
                                        <option value="8">8 Mpix (4K)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="NightVisionM" class="form-label text-muted small fw-bold">WIDOCZNOŚĆ W NOCY (M)</label>
                                    <select asp-for="NightVisionM" class="form-select form-select-dark">
                                        <option value="20">do 20 m</option>
                                        <option value="30">do 30 m (Standard)</option>
                                        <option value="50">do 50 m</option>
                                        <option value="80">powyżej 80 m</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="Detection" class="form-label text-muted small fw-bold">FUNKCJE INTELIGENTNE</label>
                                    <select asp-for="Detection" class="form-select form-select-dark" asp-items="Html.GetEnumSelectList<DetectionType>()"></select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card card-dark h-100 shadow-sm border-secondary">
                            <div class="card-header bg-transparent border-secondary py-3">
                                <h5 class="mb-0 text-white"><i class="bi bi-hdd-network text-danger me-2"></i> 3. Wyposażenie</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="DisplayMethod" class="form-label text-muted small fw-bold">PODGLĄD NA:</label>
                                    <select asp-for="DisplayMethod" class="form-select form-select-dark" asp-items="Html.GetEnumSelectList<DisplayType>()"></select>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="RecordingDays" class="form-label text-muted small fw-bold">ARCHIWIZACJA (DNI)</label>
                                    <input asp-for="RecordingDays" type="number" class="form-control form-control-dark" min="1" max="90">
                                </div>
                                <hr class="border-secondary" />
                                <div class="form-check form-switch mb-2">
                                    <input asp-for="NeedUps" class="form-check-input" type="checkbox" id="upsToggle">
                                    <label class="form-check-label text-white" asp-for="NeedUps">Zasilanie awaryjne (UPS)</label>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input asp-for="NeedCabling" class="form-check-input" type="checkbox" checked>
                                    <label class="form-check-label text-white" asp-for="NeedCabling">Okablowanie i akcesoria</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-visual" role="tabpanel">
                <div class="card bg-dark border-secondary shadow-lg">
                    <div class="card-body p-0">
                        <div class="p-2 p-md-3 border-bottom border-secondary d-flex flex-wrap gap-2 align-items-center bg-black bg-opacity-25 justify-content-center justify-content-md-start">
                            <label class="btn btn-outline-light btn-sm">
                                <i class="bi bi-upload me-1"></i> Wgraj
                                <input type="file" id="planUpload" accept="image/*" hidden>
                            </label>

                            <div class="vr bg-secondary mx-1 d-none d-md-block"></div>

                            <button type="button" class="btn btn-sm btn-outline-warning tool-btn" data-tool="scale" title="Kliknij dwa punkty i podaj odległość">
                                <i class="bi bi-ruler"></i> <span class="d-none d-sm-inline">Skala</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary tool-btn" data-tool="nvr" title="Ustaw Rejestrator">
                                <i class="bi bi-hdd-fill"></i> <span class="d-none d-sm-inline">NVR</span>
                            </button>

                            <div class="d-inline-flex align-items-center border border-secondary rounded px-2 py-1 bg-dark">
                                <button type="button" class="btn btn-sm btn-danger tool-btn me-2" data-tool="camera" title="Dodaj kamerę">
                                    <i class="bi bi-camera-video-fill"></i> <span class="d-none d-sm-inline">Kamera</span>
                                </button>
                                <select id="camTypeSelect" class="form-select form-select-sm bg-dark text-light border-0 py-0 shadow-none" style="width:auto; font-size: 0.85rem;">
                                    <option value="outdoor">Zewn.</option>
                                    <option value="indoor">Wewn.</option>
                                </select>
                            </div>

                            <div class="ms-auto d-flex align-items-center gap-2 gap-md-3">
                                <div class="text-white small text-nowrap">
                                    Kabel: <span id="cableSum" class="fw-bold text-success fs-5">0</span> m
                                </div>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="clearCanvas()">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                            </div>
                        </div>

                        <div id="canvasContainer" class="position-relative bg-secondary bg-opacity-10 overflow-hidden" style="width: 100%; cursor: crosshair;">
                            <canvas id="planCanvas" style="display:block;"></canvas>

                            <div id="canvasOverlay" class="position-absolute top-50 start-50 translate-middle text-center text-muted w-100 px-3">
                                <i class="bi bi-image fs-1 d-block mb-2"></i>
                                <p class="mb-0">Wgraj rzut budynku, aby rozpocząć.</p>
                                <small>Obsługuje formaty JPG, PNG.</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-dark border-top border-secondary text-secondary small">
                        <div class="d-flex align-items-start gap-2">
                            <i class="bi bi-info-circle-fill mt-1"></i>
                            <div>
                                <strong>Kroki:</strong> 1. Wgraj rzut &rarr; 2. Ustaw skalę (kliknij dwa końce ściany) &rarr; 3. Ustaw NVR &rarr; 4. Dodaj kamery.<br />
                                <em>System automatycznie przelicza metry kabla przy każdej zmianie rozmiaru okna.</em>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="col-12 mt-5 text-center">
            <button type="submit" class="btn btn-danger btn-lg px-5 py-3 fw-bold text-uppercase shadow-lg hover-scale rounded-pill">
                <i class="bi bi-calculator me-2"></i> Oblicz i Dobierz Sprzęt
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // --- DEFINICJE IKON (SVG Data URI) ---

        // NVR (Niebieski Serwer)
        const iconNvr = new Image();
        iconNvr.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='4' y='16' width='56' height='12' rx='2' fill='%233b82f6'/%3E%3Crect x='4' y='36' width='56' height='12' rx='2' fill='%232563eb'/%3E%3Ccircle cx='12' cy='22' r='2' fill='%23a5f3fc'/%3E%3Ccircle cx='18' cy='22' r='2' fill='%23a5f3fc'/%3E%3Ccircle cx='12' cy='42' r='2' fill='%23bfdbfe'/%3E%3C/svg%3E";

        // Kamera Zewnętrzna (Czerwona Tuba)
        const iconCamOut = new Image();
        iconCamOut.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath d='M44 24H12c-2.2 0-4 1.8-4 4v12c0 2.2 1.8 4 4 4h32c2.2 0 4-1.8 4-4V28c0-2.2-1.8-4-4-4z' fill='%23ef4444'/%3E%3Cpath d='M48 28l12-6v20l-12-6V28z' fill='%23b91c1c'/%3E%3Crect x='14' y='20' width='24' height='4' fill='%23fca5a5'/%3E%3C/svg%3E";

        // Kamera Wewnętrzna (Błękitna Kopułka)
        const iconCamIn = new Image();
        iconCamIn.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath d='M32 12C20.95 12 12 20.95 12 32h40c0-11.05-8.95-20-20-20z' fill='%2306b6d4'/%3E%3Ccircle cx='32' cy='32' r='8' fill='%23ecfeff'/%3E%3Crect x='8' y='32' width='48' height='6' fill='%230e7490'/%3E%3C/svg%3E";

        let iconsLoaded = 0;
        function onIconLoad() {
            iconsLoaded++;
            if(iconsLoaded === 3) draw();
        }
        iconNvr.onload = onIconLoad;
        iconCamOut.onload = onIconLoad;
        iconCamIn.onload = onIconLoad;

        const canvas = document.getElementById('planCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvasContainer');
        const overlay = document.getElementById('canvasOverlay');
        const upload = document.getElementById('planUpload');

        const inputOutdoor = document.getElementById('OutdoorCamCount');
        const inputIndoor = document.getElementById('IndoorCamCount');
        const inputCable = document.getElementById('hiddenCableMeters');
        const displayCable = document.getElementById('cableSum');

        let img = new Image();
        let scaleRatio = 1;
        let originalImgWidth = 0;
        let originalImgHeight = 0;

        let logic = {
            scalePixels: 0,
            nvr: null,
            cameras: [],
            scalePoints: []
        };

        let activeTool = null;

        function draw() {
            canvas.width = container.clientWidth;
            if (img.src && originalImgWidth > 0) {
                canvas.height = canvas.width * (originalImgHeight / originalImgWidth);
                scaleRatio = canvas.width / originalImgWidth;
            } else {
                canvas.height = 400;
                scaleRatio = 1;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (img.src) {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            }

            const toScreen = (pos) => ({ x: pos.x * scaleRatio, y: pos.y * scaleRatio });

            // Rysuj Kable
            if (logic.nvr) {
                const screenNvr = toScreen(logic.nvr);
                logic.cameras.forEach(cam => {
                    const screenCam = toScreen(cam);
                    ctx.beginPath();
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = cam.type === 'outdoor' ? 'rgba(239, 68, 68, 0.5)' : 'rgba(6, 182, 212, 0.5)';
                    ctx.moveTo(screenNvr.x, screenNvr.y);
                    ctx.lineTo(screenCam.x, screenCam.y);
                    ctx.stroke();
                });
            }

            // Rysuj Skalę
            if (logic.scalePoints.length > 0) {
                ctx.fillStyle = '#f59e0b';
                logic.scalePoints.forEach(p => {
                    const sp = toScreen(p);
                    ctx.beginPath(); ctx.arc(sp.x, sp.y, 5, 0, Math.PI*2); ctx.fill();
                });
                if(logic.scalePoints.length === 2) {
                    const p1 = toScreen(logic.scalePoints[0]);
                    const p2 = toScreen(logic.scalePoints[1]);
                    ctx.beginPath(); ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]);
                    ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); ctx.setLineDash([]);
                }
            }

            // Rysuj NVR (IKONA)
            if (logic.nvr) {
                const sn = toScreen(logic.nvr);
                const size = 48;
                ctx.drawImage(iconNvr, sn.x - size/2, sn.y - size/2, size, size);

                ctx.fillStyle = '#3b82f6';
                ctx.font = 'bold 12px Arial';
                ctx.shadowColor="black"; ctx.shadowBlur=3;
                ctx.fillText("NVR", sn.x - 12, sn.y + size/2 + 10);
                ctx.shadowBlur=0;
            }

            // Rysuj Kamery (IKONY)
            logic.cameras.forEach((cam, i) => {
                const sc = toScreen(cam);
                const icon = cam.type === 'outdoor' ? iconCamOut : iconCamIn;
                const size = 36;
                ctx.drawImage(icon, sc.x - size/2, sc.y - size/2, size, size);

                ctx.fillStyle = cam.type === 'outdoor' ? '#ef4444' : '#06b6d4';
                ctx.font = 'bold 12px Arial';
                ctx.shadowColor="black"; ctx.shadowBlur=3;
                const lbl = (cam.type === 'outdoor' ? 'Z' : 'W') + (i+1);
                ctx.fillText(lbl, sc.x - 8, sc.y + size/2 + 10);
                ctx.shadowBlur=0;
            });
        }

        window.addEventListener('resize', draw);

        upload.addEventListener('change', function(e) {
            if(this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    img = new Image();
                    img.src = evt.target.result;
                    img.onload = () => {
                        overlay.style.display = 'none';
                        originalImgWidth = img.width;
                        originalImgHeight = img.height;

                        logic = { scalePixels: 0, nvr: null, cameras: [], scalePoints: [] };
                        updateForm();
                        draw();
                    }
                }
                reader.readAsDataURL(this.files[0]);
            }
        });

        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active', 'bg-white', 'text-dark'));
                if (activeTool === this.dataset.tool) {
                    activeTool = null;
                } else {
                    activeTool = this.dataset.tool;
                    this.classList.add('active', 'bg-white', 'text-dark');
                }
                if(activeTool !== 'scale') logic.scalePoints = [];
                draw();
            });
        });

        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const xCanvas = evt.clientX - rect.left;
            const yCanvas = evt.clientY - rect.top;

            return { x: xCanvas / scaleRatio, y: yCanvas / scaleRatio };
        }

        canvas.addEventListener('mousedown', function(e) {
            if (!img.src) return;
            const pos = getMousePos(e);

            if (activeTool === 'nvr') {
                logic.nvr = pos;
                recalcCables();
            }
            else if (activeTool === 'camera') {
                if (!logic.nvr) { alert("Najpierw ustaw Rejestrator (NVR)!"); return; }
                if (logic.scalePixels === 0) { alert("Najpierw ustaw skalę!"); return; }

                const type = document.getElementById('camTypeSelect').value;
                logic.cameras.push({ x: pos.x, y: pos.y, type: type });

                updateForm();
                recalcCables();
            }
            else if (activeTool === 'scale') {
                logic.scalePoints.push(pos);
                if (logic.scalePoints.length === 2) {
                    const dist = Math.hypot(logic.scalePoints[1].x - logic.scalePoints[0].x, logic.scalePoints[1].y - logic.scalePoints[0].y);
                    const meters = prompt("Podaj rzeczywistą długość odcinka (m):", "10");

                    if (meters && !isNaN(meters) && parseFloat(meters) > 0) {
                        logic.scalePixels = dist / parseFloat(meters);
                        alert("Skala zapisana!");
                    } else {
                        logic.scalePoints = [];
                    }

                    logic.scalePoints = [];
                    document.querySelector('[data-tool="scale"]').click();
                }
            }
            draw();
        });

        function recalcCables() {
            if (!logic.nvr || logic.scalePixels === 0) return;

            let total = 0;
            logic.cameras.forEach(cam => {
                const distPix = Math.hypot(cam.x - logic.nvr.x, cam.y - logic.nvr.y);
                const m = (distPix / logic.scalePixels) * 1.2 + 3;
                total += m;
            });

            const final = Math.ceil(total);
            displayCable.innerText = final;
            inputCable.value = final;
        }

        function updateForm() {
            const out = logic.cameras.filter(c => c.type === 'outdoor').length;
            const ind = logic.cameras.filter(c => c.type === 'indoor').length;

            inputOutdoor.value = out;
            inputIndoor.value = ind;
        }

        function clearCanvas() {
            if(confirm("Usunąć wszystkie elementy z mapy?")) {
                logic = { scalePixels: 0, nvr: null, cameras: [], scalePoints: [] };
                displayCable.innerText = "0";
                inputCable.value = "";
                updateForm();
                draw();
            }
        }
    </script>
}